## **Introduction**

This workflow automates the **Protein Structure Prediction** process, leveraging both template-based modeling (MODELLER) and AI-driven tools (ColabFold) to predict accurate 3D protein structures. The pipeline integrates sequence alignment, structural modeling, and refinement steps, offering a streamlined solution for researchers working on computational protein modeling.

This repository demonstrates a **fully automated workflow**, where **three FASTA files** were processed simultaneously. The workflow handled each input gracefully, ensuring proper parallel execution and organized the outputs systematically in the `output` directory. This showcases the robustness and scalability of the pipeline for handling multiple protein sequences in a single run.

### **Overview**

- The project aims to simplify and standardize protein structure prediction workflows.
- It supports both template-based (homology modeling) and AI-based approaches, offering flexibility based on input data and research goals.
- The workflow is fully automated and configurable, utilizing Conda environments and Snakemake for reproducibility.
- Key outputs include high-quality protein structures, alignment files, logs, and analysis results, all organized into a user-friendly directory structure.

---
## **Installation Guide**

### **Docker Image**

The Protein Structure Prediction workflow is prepackaged in a Docker image for straightforward deployment:

- **Docker Image**:
 ```bash
docker pull edjosef96/protein_structure_prediction:v2.0.1
   ```

---

## **Usage Instructions**

### **Running the Workflow**

To execute the Protein Structure Prediction workflow, use the following command after adding your FASTA files to the `input` directory and mounting it:

```bash
docker run -v /path/to/input:/workspace/input -v /path/to/output:/workspace/output --resources gpu=2 --cores all edjosef96/protein_structure_prediction:v2.0.1
```

### **Notes:**

- The workflow processes multiple FASTA files simultaneously.
- If your FASTA files contain **multiple chains**, it is recommended to run the workflow with the `--jobs 1` flag to avoid issues during the splitting and renaming of the files in `split.sh`. Example:
```bash
docker run -v /path/to/input:/workspace/input -v /path/to/output:/workspace/output --resources gpu=2 --cores all --jobs 1 edjosef96/protein_structure_prediction:v2.0.1 
```



---
## **Project Structure**

- **`./input`**:  
    Directory containing the input FASTA sequence files.
- **`./output`**:  
    Directory for storing all outputs generated by the workflow:
    - **`./colab_fold_output`**:  
        Contains all the LocalColabFold outputs. Each FASTA file processed has its own directory, including a log file for the LocalColabFold run.
    - **`./modeller_output`**:  
        Contains all MODELLER outputs. Each processed FASTA file is organized into its own directory. Each directory includes logs, analysis reports, and the final PDB structure after rotamer sampling.
- **`./localcolabfold`**:  
    Directory generated post-simulation, containing the LocalColabFold installation.
- **`./modeller`**:  
    Directory containing all the MODELLER scripts.
- **`./Snakefile`**:  
    Snakemake workflow file for automating the simulation steps.
- **`./snake_env.yml`**:  
    Conda environment configuration file specifying dependencies.
- **`./setup_env.sh`**:  
    Bash script for installing dependencies and creating the Conda environment.
- **`README.md`**:  
    Documentation file providing an overview and usage instructions for the workflow.
- **`Dockerfile`**:  
    File specifying the Docker image setup for the workflow.
- **`snakemake_full.log`**:  
    Contains the log details of the Snakemake run.
- **`Theoretical_Documentation.md`**:  
    Detailed theoretical documentation explaining the methodology, implementation, and scientific principles behind the workflow.
    

---
## **Technical Documentation**

 **1- LocalColabFold Workflow:**

- **Input**:
    - FASTA files from the `input/` directory.
    - ColabFold batch executable from `localcolabfold/colabfold-conda/bin/colabfold_batch`.
- **Execution**:
    - Sets the ColabFold executable path in the environment.
    - The model is chosen automatically based on input.
    - Executes `colabfold_batch` with the following parameters:
        - `--num-recycle 3`: Specifies the number of recycling iterations.
        - `--num-ensemble 2`: Specifies the number of ensemble evaluations.
        - `--amber`: Enables AMBER force field refinement.
        - `--pair-mode paired`: Assumes paired sequences in MSA mode.
        - `--stop-at-score 95`: Stops prediction if confidence score reaches 95.
        - `--msa-mode mmseqs2_uniref_env`: Uses MMseqs2 for MSA generation.
        - `--templates`: Enables template-based modeling.
- **Output**:
    - Each FASTA file generates:
        - A separate directory in `output/colab_fold_output/{SAMPLE_NAME}`.
        - Predicted PDB structures and additional result files.
        - A log file (`log.txt`) capturing details of the prediction process.


**2- Modeller Workflow:**

- **`split.sh`**:
    - **Input Validation**: Ensures the input file is in the correct format.
    - **File Splitting**: Splits multi-chain FASTA files into individual chains for separate processing.
- **`convert_fasta.sh`**:
    - Converts FASTA files into MODELLER-compatible `.ali` alignment format.
- **`build_profile.py`**:
    - **Profile Generation**: Builds a sequence profile using the `.ali` file.
    - **Template Ranking**: Identifies and ranks potential templates based on sequence similarity.
- **Template Selection**:
    - Selects the best-ranked template based on scores from `build_profile.prf`.
- **`download.py`**:
    - Downloads the PDB file corresponding to the selected template.
- **`fix_template.py`**:
    - **Template Cleaning**: Fixes structural issues such as missing residues and atoms, ensuring compatibility with MODELLER.
- **`align2d.py`**:
    - Aligns the target sequence with the cleaned template structure.
- **`modeller_automodel.py`**:
    - **Homology Modeling**: Generates multiple 3D models of the target sequence based on the template.
    - **Model Scoring**: Evaluates models using DOPE and GA341 scores to identify the best structure.
- **Rotamer Sampling**:
    - **SCWRL4**: Optimizes side-chain conformations in the selected model to improve structural accuracy.
- **Output Organization**:
    - Creates a directory for each FASTA file to store alignment files, logs, analysis reports, and the final predicted structure.
- **File Cleanup**:
    - Removes intermediate FASTA files and organizes all results into a centralized `modeller_output` directory.
---
## **Outputs**

- **`output/colab_fold_output`**:
    - `run_colab_fold.log`: Contains detailed logs for the entire ColabFold run.
    - Separate directories named after each processed FASTA file, containing:
        - The final ranked and relaxed PDB structures.
        - `log.txt`: ColabFold-generated logs specific to this FASTA file.
- **`output/modeller_output`**:
    - Contains separate folders for each processed FASTA file. If a FASTA file has multiple chains, each chain is assigned its own folder. Each folder includes:
        - **5 PDBs**: Structures built by `modeller_automodel.py`.
        - `{input}_final.pdb`: The final structure resulting from rotamer sampling.
        - **Log Files**:
            - Logs for all executed scripts, such as `build_profile.log` and `modeller_automodel.log`.
            - `log_file.log`: Contains a list of all templates generated by `build_profile.py`.
        - `template.txt`: Specifies the chosen template used for the prediction.
        - `analysis_report_template.txt`: contains all the fixes done to the downloaded template structure.

